# Лабораторная работа №4

## Часть 1. Python

### 1.2. Эхо-запросы через ICMP

Программа дописана (см. файл `icmp_ping.py`). Пример работы:

![](attachments/Pasted%20image%2020260108202751.png)

### 1.3. Трассировка маршрута через ICMP

Программа дописана (см. файл `icmp_tracert.py`). Пример работы:

![](attachments/Pasted%20image%2020260108202640.png)

## Часть 2. Wireshark

### 2.1. ICMP

В cmd выполнена команда `ping www.ust.hk -n 10`.

Запрос:
![](attachments/Pasted%20image%2020260108210156.png)

Ответ:
![](attachments/Pasted%20image%2020260108210127.png)

1. IP-адрес клиента: 192.168.1.101. IP-адрес хоста назначения: 143.89.14.34.
2. Порт, как правило, привязывается к определенному сервису. Протокол ICMP обменивается сообщениями L2, содержащими информацию о самих хостах / серверах / ..., а не о каких-то процессах.
3. Рассмотрим пакет №3 (запрос к серверу от клиента). ICMP-тип: 8, Echo (ping) request. Код: 0.
   Также имеются поля контрольной суммы, идентификатора и порядкового номера (в Wireshark расшифровываются в двух вариантах: Big Endian и Little Endian). Каждое из этих полей занимает по 2 байта.
4. Рассмотрим пакет №4 (ответ сервера клиенту). Тип: 0, Echo (ping) reply. Код: 0.
   Также имеются поля контрольной суммы, идентификатора и порядкового номера. Их формат аналогичен запросу. Значения идентификатора и порядкового номера равны указанным в запросе.

Выполним команду: `tracert www.inria.fr`. Вывод команды:

![](attachments/Pasted%20image%2020260108213342.png)

Захвачено большое количество ICMP-пакетов. В том числе имеются сообщения с ошибкой TTL exceeded. В ICMP-заголовках таких пакетов полей больше, чем в обычных.

![](attachments/Pasted%20image%2020260108213949.png)

5. IP-адрес клиента: 192.168.0.179. IP-адрес хоста назначения: 128.93.162.83.
6. Если по протоколу ICMP будут посылаться UDP-пакеты, то номер протокола в заголовке IP будет равен 17 (UDP).
7. ICMP эхо-запрос имеет те же поля, что и полученные при помощи утилиты ping.
   ![](attachments/Pasted%20image%2020260108214620.png)
8. ICMP-пакеты с сообщениями об ошибке не такие, как ping-пакеты с запросами. В пакете с сообщением об ошибке содержится как IP-заголовок, так и первые 8 байт исходного ICMP-пакета, в котором произошла ошибка.
   ![](attachments/Pasted%20image%2020260108215151.png)
9. Тип сообщения у последних трех ICMP-пакетов равен 0 (эхо-запрос), а не 11 (предписанное время жизни исчерпано). Типы отличаются, так как дейтаграммы успевают достичь хоста назначения до того, как истечет их предписанное время жизни.
   ![](attachments/Pasted%20image%2020260108215523.png)

### 2.2. IP

Установлено ПО PingPlotter. Запущен анализ gaia.cs.umass.edu с размером ICMP-пакета 56 байт.

Окно PingPlotter:
![](attachments/Pasted%20image%2020260108221735.png)

Результат захвата трафика:
![](attachments/Pasted%20image%2020260108222032.png)

1. Мой адрес: 192.168.0.179. 
2. Протокол верхнего уровня: ICMP (1).
3. В IP-заголовке 20 байт. Размер полезной нагрузки IP-дейтаграммы: 56 (поле Total Length) - 20 = 36 байт.
4. Разряд More fragments (Дополнительные фрагменты) равен 0 – значит, данные не фрагментированы.
5. Всегда изменяются поля Identification (Идентификационная информация), Time to live (Предписанное время жизни) и Header checksum (Контрольная сумма заголовка).
6. Следующие поля остаются неизменными во всех IP-дейтаграммах
	- Версия (поскольку во всех протоколах используется протокол IPv4)
	- Длина заголовка (поскольку все эти пакеты передаются по протоколу
	ICMP)
	- Исходный IP (поскольку мы посылаем все дейтаграммы с одного и того же
	хоста)
	- Конечный IP (поскольку мы посылаем все дейтаграммы на один и тот же
	хост)
	- Дифференцированные службы (поскольку все сообщения передаются по
	протоколу ICMP, они используют один и тот же класс «Тип сервиса»)
	- Протокол верхнего уровня (поскольку все пакеты передаются по протоколу
	ICMP)
	Поля, которые должны оставаться неизменными:
	- Версия (поскольку во всех протоколах используется протокол IPv4)
	- Длина заголовка (поскольку все эти пакеты передаются по протоколу
	ICMP)
	- Исходный IP (поскольку мы посылаем все дейтаграммы с одного и того же
	хоста)
	- Конечный IP (поскольку мы посылаем все дейтаграммы на один и тот же
	хост)
	- Дифференцированные службы (поскольку все сообщения передаются по
	протоколу ICMP, они используют один и тот же класс «Тип сервиса»)
	- Протокол верхнего уровня (поскольку все пакеты передаются по протоколу
	ICMP)
	Поля, которые должны изменяться:
	- Идентификационная информация (все пакеты должны иметь разные
	идентификаторы)
	- Предписанное время жизни (программа Traceroute увеличивает это
	значение у каждого последующего пакета)
	- Контрольная сумма заголовка (поскольку изменяется заголовок – должна
	меняться и его контрольная сумма)
7. Значение в поле идентификационной информации IP-пакета возрастает с каждым последующим пингом.
8. Identification содержит некое уникальное в рамках цепочки от данного отправителя значение. TTL содержит значение 64.
9. В сообщениях с данного маршрутизатора ID монотонно увеличиваются, TTL ставится тот же.

Заменим размер пакета в PingPlotter на 2000 байт. Теперь ICMP-запросы разбиваются на две IP-дейтаграммы.

![](attachments/Pasted%20image%2020260108225049.png)

10. Теперь сообщение фрагментировано на 2 дейтаграммы, о чем говорит флаг More Fragments в записи номер 210, связанной с 211.
11. More Fragments = 1 в первой из 2 дейтаграмм. При этом Fragment Offset = 0, что говорит о том, что перед нами первая дейтаграмма.
12. В 1 и 2 фрагментах отличаются Flags (More Fragments только у первого), длина, сдвиг, контрольная сумма, идентификатор.

Изменим размер пакета на 3500 байт.

![](attachments/Pasted%20image%2020260108225726.png)

14. Теперь ICMP-запрос разбивается на 3 дейтаграммы.
15. Изменяются те же поля, что в случае с 2 дейтаграммами.